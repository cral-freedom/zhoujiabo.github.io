<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>【编写RTOS】简单任务调度 | Zhou&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="SysTick,PendSV">
    <link rel="shortcut icon" href="https://i.loli.net/2020/02/12/5oNk3WDtxXbymYI.jpg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="/zhoujiabo.github.io/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false}'),
            v: JSON.parse('{"enable":true,"appid":"ryu5gppP7IkOwtkX6qHMcct2-gzGzoHsz","appkey":"cROffFABz0EqQwYOsqfhJtex","notify":false,"verify":false,"visit_counter":true,"placeholder":"you can comment here","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/zhoujiabo.github.io/atom.xml" title="Zhou's Blog" type="application/atom+xml">
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="https://i.loli.net/2020/02/12/or1sdw4mkOEgLTS.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/zhoujiabo.github.io/" class="avatar waves-effect waves-circle waves-light">
          <img src="https://i.loli.net/2020/02/12/vtkHuf7DyOIhaST.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">zhoujiabo</h5>
          <a href="mailto:2632213328@qq.com" title="2632213328@qq.com" class="mail">
            
              <span>2</span>
            
              <span>6</span>
            
              <span>3</span>
            
              <span>2</span>
            
              <span>2</span>
            
              <span>1</span>
            
              <span>3</span>
            
              <span>3</span>
            
              <span>2</span>
            
              <span>8</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/cral-freedom" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/zhoujiabo.github.io/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/zhoujiabo.github.io/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/zhoujiabo.github.io/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/zhoujiabo.github.io/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/zhoujiabo.github.io/custom"  >
                <i class="icon icon-lg icon-plus-square"></i>
                CUSTOM
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>【编写RTOS】简单任务调度</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="https://i.loli.net/2020/02/12/9JrZUIzeSGMnbu7.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">【编写RTOS】简单任务调度</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-08T13:34:00.000Z" itemprop="datePublished" class="page-time">
  2020-05-08
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/zhoujiabo.github.io/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-【编写RTOS】简单任务调度"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">【编写RTOS】简单任务调度</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-08 21:34:00" datetime="2020-05-08T13:34:00.000Z"  itemprop="datePublished">2020-05-08</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/zhoujiabo.github.io/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/">嵌入式</a></li></ul>



            

            
    <span class="leancloud-comment">
        <i class="icon icon-comment-o"></i>
        <a href="/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/#comment">
            <span class="valine-comment-count" data-xid="/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/"></span>
        </a>
    </span>



            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>回顾</p>
<blockquote>
<p>Q3：关于RTOS编写，要解决哪些核心问题<br>A3：<br> a. 系统心跳：SysTick初始化<br> b. SysTick和PendSV的优先级设置<br> c. 任务控制块TCB结构与堆栈初始化<br> d. 上下文切换：PendSV_Handler函数<br> e. 系统延时函数（阻塞，调度）<br> f. 任务调度：SysTick_Handler函数</p>
</blockquote>
<p>理清问题关键所在后，开始动手。</p>
<blockquote>
<p>我是边动手边折腾，慢慢才理楚问题关键；<br>    &emsp;首先，<strong>最基本的功能要先保证</strong>，如SysTick初始化，任务堆栈初始化，上下文切换；<br>    &emsp;然后，开始时<strong>步子不能迈太大</strong>，我就差点裂开了。开始时只想着时间片轮转调度，选择了循环队列来管理列表，结果发现延时列表不能适用，它需要将延时短的任务先取出；然后又傻傻地想，用min_heap来实现优先级队列，它好像很适合动态管理数据，结果因为要判断”叶“的位置，需要额外的空间，多次malloc后失败，因为Heap_Size只有0x00000200 = 512字节（搞来搞去，结构体指针数组初始化，非法访问，数据被破坏，，，）。最后直接用一个结构体指针数组+任务状态来管理了。先搞出来，然后才能谈其它数据结构，优化调度算法</p>
</blockquote>
<br>
<big>1、SysTick</big>

<p>①SysTick的作用：<br>    &emsp;通过SysTick异常周期性地切入系统，进行任务调度。 （SysTick 的最大使命，就是定期地产生异常请求，作为系统的时基。 OS 都需要这种“滴答” 来推动任务和时间的管理。—— CM3权威指南）</p>
<p>②关于SysTick，我们需要知道什么?<br>    &emsp;所有CM3芯片内部都包含了SysTick定时器（简化了在CM3器件间的软件移植工作），该定时器的时钟源可以是内部时钟，或者是外部时钟。<br>    &emsp;SysTick定时器是一个24位的倒计数定时器，当计数到0时，将从RELOAD寄存器中自动重载定时器初值，开始新的一轮计数。STM32的延时一般就是通过内部的SysTick来实现的。<br>     &emsp;STM32基础例程中有关SysTick定时器的初始化设置，可以在delay.c文件（源自正点原子FreeRTOS例程）中查看。delay_init()中也有关于SysTick时钟源的说明：SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK); 由此可知，SysTick的时钟源是HCLK。   </p>
<blockquote>
<p>HCLK ：AHB总线时钟，由系统时钟SYSCLK分频得到，一般不分频，等于系统时钟（72MHZ），HCLK是高速外设时钟，是给外部设备的，比如内存，flash，DMA。</p>
</blockquote>
<p>SysTick控制及状态寄存器：<br> <figure class="image-box">
                <a rel=【编写RTOS】简单任务调度 href="https://file.moetu.org/images/2020/05/08/5adc689039222e50b48511a48a43a3f1e380b32518925fd1.md.png" target="_blank" title="" data-fancybox="images"><img src="https://file.moetu.org/images/2020/05/08/5adc689039222e50b48511a48a43a3f1e380b32518925fd1.md.png" alt="" title="" class=""></a>
                <p></p>
            </figure>   </p>
<p>初始化代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void SysTick_Init(void)</span><br><span class="line">&#123;</span><br><span class="line">	char *Systick_priority = (char *)0xe000ed23;	//Systick中断优先级寄存器</span><br><span class="line">	*Systick_priority = 0x00;           			//设置SysTick中断优先级最高</span><br><span class="line">	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK);//选择外部时钟  HCLK</span><br><span class="line">	SysTick-&gt;LOAD  = ( SystemCoreClock / configTICK_RATE_HZ) - 1UL;	//定时周期1ms</span><br><span class="line">	SysTick-&gt;VAL   = 0;                            	//Systick定时器计数器清0</span><br><span class="line">	//SysTick-&gt;CTRL: bit0-定时器使能 bit1-中断使能 bit2-时钟源选择(=1系统主频，=0系统主频/8)</span><br><span class="line">	SysTick-&gt;CTRL = 0x7;	//选择外部时钟，允许中断，开启定时器</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>敲重点：<br>①SysTick-&gt;CTRL: bit0-定时器使能 bit1-中断使能 bit2-时钟源选择(=1系统主频，=0系统主频/8)；<br>②重装载值计算原理：系统时钟频率为72M，1秒钟计数72M次，现SysyTick时钟也为72M，但计数72M/1000次（计数范围：72M/1000-1 ~ 0），可得1ms(1/1000秒)重装载一次。</p>
</blockquote>
<br>
<big>2、PendSV</big>

<p>①PendSV作用：任务切换时保存上下文（将一些寄存器和变量的值保存到任务堆栈，或将任务堆栈出栈，恢复过去任务的运行环境)</p>
<blockquote>
<p>将任务堆栈出栈,就是将要运行的任务的堆栈的栈顶赋给sp，只有知道了sp我们才能找到对应的任务堆栈，才能找到堆栈保存任务信息。<br>恢复任务过去的运行环境（如通过恢复PC的值，我们可以知道上一次这个任务运行到哪了）</p>
</blockquote>
<p>②悬起PendSV的方法是：手工往NVIC的PendSV悬起寄存器中写1。</p>
<figure class="image-box">
                <a rel=【编写RTOS】简单任务调度 href="https://file.moetu.org/images/2020/05/08/b614e93ce0474a2120ce2fe9605593b5f688e57444646af6.md.png" target="_blank" title="" data-fancybox="images"><img src="https://file.moetu.org/images/2020/05/08/b614e93ce0474a2120ce2fe9605593b5f688e57444646af6.md.png" alt="" title="" class=""></a>
                <p></p>
            </figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int* NVIC_INT_CTRL= (int *)0xE000ED04;  //中断控制寄存器地址</span><br><span class="line">void SetPendSV(void)//挂起PendSV</span><br><span class="line">&#123;</span><br><span class="line">	*NVIC_INT_CTRL=0x10000000;//1&lt;&lt;28</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③PendSV的中断优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void PendSVPriority_Init(void)</span><br><span class="line">&#123;</span><br><span class="line">	char* NVIC_SYSPRI14= (char *)0xE000ED22;  		//PendSV优先级寄存器地址</span><br><span class="line">	*NVIC_SYSPRI14=0xFF;							//设置PendSV中断优先级最低 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
<big>3、TCB与任务堆栈</big>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######task.h文件######</span></span><br><span class="line"></span><br><span class="line">typedef enum</span><br><span class="line">&#123;</span><br><span class="line">	eTask_Running = 0,</span><br><span class="line">	eTask_Ready,</span><br><span class="line">	eTask_Suspended,</span><br><span class="line">	eTask_Blocked,</span><br><span class="line">	eTask_Deleted,</span><br><span class="line">&#125;eTaskSta;</span><br><span class="line"></span><br><span class="line"><span class="comment">#define OS_MAX_TASK 8	//最大任务数量</span></span><br><span class="line">typedef struct _TaskControlBlock</span><br><span class="line">&#123;</span><br><span class="line">	stk32 *StkPtr;</span><br><span class="line">	char name[16];</span><br><span class="line">	int state;	//任务状态</span><br><span class="line">	int prio;</span><br><span class="line">	int DlyTim; //任务阻塞时间</span><br><span class="line">&#125;TCB,*pTCB;</span><br><span class="line">extern pTCB TASK_LIST[OS_MAX_TASK];</span><br><span class="line">extern int created_task_num;</span><br><span class="line"></span><br><span class="line">stk32* task_stk_init(void* func, stk32 *TopOfStack);</span><br><span class="line">void create_new_task( void *func, char name[], int prio, stk32 *TopOfStack, pTCB *tcb);</span><br><span class="line">int GetTaskNum(eTaskSta state);</span><br><span class="line">pTCB GetHighRdyTask(void);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######task.c文件######</span></span><br><span class="line"></span><br><span class="line">pTCB TASK_LIST[OS_MAX_TASK];</span><br><span class="line">int created_task_num = 0;//全局变量</span><br><span class="line">//任务堆栈初始化</span><br><span class="line">//入栈顺序：栈顶-&gt;栈尾 xPSR,PC,LR,R12,R3-R0,R4-R11共16个(SP(R13)保存在TCB首个成员变量中)。</span><br><span class="line">stk32* task_stk_init(void* func, stk32 *TopOfStack)</span><br><span class="line">&#123;</span><br><span class="line">    stk32 *stk;</span><br><span class="line">    stk = TopOfStack;</span><br><span class="line">    *(stk)    = (u32)0x01000000L;//xPSR 程序状态寄存器，xPSR T位(第24位)必须置1,否则第一次执行任务时进入Fault中断                                                     </span><br><span class="line">    *(--stk)  = (u32)func;   //PC   初使化时指向任务函数首地址（任务切换时，可能指向任务函数中间某地址）            </span><br><span class="line">	*(--stk)  = (u32)0xFFFFFFFEL;//LR   保存着各种跳转的返回连接地址,初使化为最低4位为E，是一个非法值，主要目的是不让使用R14，即任务是不能返回的              </span><br><span class="line">	stk-=13;	</span><br><span class="line">    <span class="built_in">return</span> stk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void create_new_task( void *func, char name[], int prio, stk32 *TopOfStack, pTCB *tcb)</span><br><span class="line">&#123;</span><br><span class="line">	int name_len = strlen(name);</span><br><span class="line">	irq_disable();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(created_task_num == OS_MAX_TASK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Create Task Fail\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(tcb)</span><br><span class="line">	&#123;</span><br><span class="line">		*tcb = (pTCB)malloc(sizeof(TCB));</span><br><span class="line">		<span class="keyword">if</span>(*tcb)</span><br><span class="line">		&#123;</span><br><span class="line">			(*tcb)-&gt;StkPtr = task_stk_init(func,TopOfStack);</span><br><span class="line">			memcpy((*tcb)-&gt;name,name,sizeof(char)*name_len);</span><br><span class="line">			(*tcb)-&gt;state = eTask_Ready;</span><br><span class="line">			(*tcb)-&gt;prio = prio;</span><br><span class="line">			(*tcb)-&gt;DlyTim = 0;	</span><br><span class="line">			TASK_LIST[created_task_num] = *tcb;</span><br><span class="line">			created_task_num++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	irq_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int GetTaskNum(eTaskSta state)</span><br><span class="line">&#123;</span><br><span class="line">	int i, num = 0;</span><br><span class="line">	<span class="keyword">for</span>(i = 0; i &lt; created_task_num; i++)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="keyword">if</span>(TASK_LIST[i]-&gt;state == state)</span><br><span class="line">			num++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">////数字越大，任务优先权越高</span><br><span class="line">extern pTCB pTCB_IDLE;</span><br><span class="line">pTCB GetHighRdyTask(void)</span><br><span class="line">&#123;</span><br><span class="line">	int i = 0;</span><br><span class="line">	pTCB pTtmp ,pTrdy = pTCB_IDLE;</span><br><span class="line">	<span class="keyword">for</span>(i = 0; i &lt; created_task_num; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(TASK_LIST[i]-&gt;state == eTask_Ready)</span><br><span class="line">		&#123;</span><br><span class="line">			pTtmp = TASK_LIST[i];</span><br><span class="line">			<span class="keyword">if</span>(pTtmp-&gt;prio &gt; pTrdy-&gt;prio)</span><br><span class="line">				pTrdy = pTtmp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> pTrdy;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>敲重点：<br>①“stk32 *StkPtr;”必须放在任务控制块的首位；<br>②入栈顺序与PendSV保存和恢复现场过程有关<br>③没有另外维护就绪、延时列表，只用了一个结构体指针数组，利用任务的状态来管理（任务数量少时影响不大）</p>
</blockquote>
<br>
<big>4、上下文切换：PendSV_Handler函数</big>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">	IMPORT pTCB_Cur</span><br><span class="line">	IMPORT pTCB_Rdy	</span><br><span class="line">	EXPORT PendSV_Handler</span><br><span class="line">	EXPORT SP_INIT</span><br><span class="line">		</span><br><span class="line">	PRESERVE8                  ;//字节对齐关键词,指定当前文件八字节对齐。</span><br><span class="line">	AREA |.text|, CODE, READONLY ;//定义一个代码段或数据段。</span><br><span class="line">	THUMB                      ;//指定以下指令都是THUMB指令集(ARM汇编有多种指令集)</span><br><span class="line"></span><br><span class="line">SP_INIT  					   ;初始化PSP指针                      </span><br><span class="line">    CPSID    I                 ;//关闭全局中断 </span><br><span class="line">	</span><br><span class="line">    LDR R4,=0x0                ;//R4装载立即数0(不直接给PSP赋值0而是经进R寄存器作为媒介是因为PSP只能和R寄存器打交道)            </span><br><span class="line">    MSR     PSP, R4            ;//PSP(process stack pointer)程序堆栈指针赋值0。PSP属用户级(特级权下为MSP)，双堆栈结构。 </span><br><span class="line">	</span><br><span class="line">    CPSIE    I                 ;//打开全局中断(此时若没有其他中断在响应，则立即进入PendSV中断函数)  </span><br><span class="line">    BX    LR  </span><br><span class="line">    </span><br><span class="line">;/******************PendSV_Handler************/</span><br><span class="line">PendSV_Handler</span><br><span class="line">    CPSID    I                            ; OS_ENTER_CRITICAL();</span><br><span class="line">	</span><br><span class="line">    MRS     R0, PSP                            ; R0 = PSP;</span><br><span class="line">    CBZ     R0, PendSV_Handler_NoSave          ; <span class="keyword">if</span>(R0 == 0) goto PendSV_Handler_NoSave;</span><br><span class="line">    </span><br><span class="line">    SUB     R0, R0, <span class="comment">#0x20            ; R0 = R0 - 0x20;</span></span><br><span class="line">    </span><br><span class="line">    ; easy method</span><br><span class="line">    STM     R0, &#123;R4-R11&#125;</span><br><span class="line">    </span><br><span class="line">    LDR     R1, =pTCB_Cur            ; R1 = OSTCBCur;</span><br><span class="line">    LDR     R1, [R1]                 ; R1 = *R1;(R1 = OSTCBCur-&gt;OSTCBStkPtr)</span><br><span class="line">    STR     R0, [R1]                 ; *R1 = R0;(*(OSTCBCur-&gt;OSTCBStkPrt) = R0)</span><br><span class="line"> </span><br><span class="line">PendSV_Handler_NoSave				;每次都会进去（因为PendSV_Handler_NoSave不是函数，而是中间的一个标签，用于跳转）</span><br><span class="line"></span><br><span class="line">	;实质就是pTCB_Cur = pTCB_Rdy</span><br><span class="line">	;每次运行PendSV_Handler，都会使pTCB_Cur指向pTCB_Rdy，所以调度时只需从任务数组中获取pTCB_Rdy</span><br><span class="line">    LDR     R0, =pTCB_Cur           ; R0 = OSTCBCur;</span><br><span class="line">    LDR     R1, =pTCB_Rdy           ; R1 = OSTCBNext;</span><br><span class="line">    LDR     R2, [R1]                ; R2 = OSTCBNext-&gt;OSTCBStkPtr;</span><br><span class="line">    STR     R2, [R0]                ; *R0 = R2;(OSTCBCur-&gt;OSTCBStkPtr = OSTCBNext-&gt;OSTCBStkPtr)</span><br><span class="line">    </span><br><span class="line">    LDR     R0, [R2]                 ; R0 = *R2;(R0 = OSTCBNext-&gt;OSTCBStkPtr)</span><br><span class="line">    LDM     R0, &#123;R4-R11&#125;</span><br><span class="line">    ADD    R0, R0, <span class="comment">#0x20</span></span><br><span class="line"> </span><br><span class="line">    MSR     PSP, R0                 ; PSP = R0;(PSP = OSTCBNext-&gt;OSTCBStkPtr)</span><br><span class="line">    ORR     LR, LR, <span class="comment">#0x04           ; LR = LR | 0x04;</span></span><br><span class="line">	</span><br><span class="line">    CPSIE     I                     ; OS_EXIT_CRITICAL();</span><br><span class="line">    BX    LR                        ; <span class="built_in">return</span>;                                       ; Enable interrupts at processor level</span><br><span class="line">	</span><br><span class="line">	align 4                    ;//内存对齐指令(编译器提供的)，以4个字节(32位)对齐</span><br><span class="line">    end                        ;//伪指令,放在程序行的最后,告诉编译器编译程序到此结束</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我也不是特别懂汇编，就说几个注意点：<br>①PendSV_Handler在kernel.asm中定义了，需要注释掉原来的函数（在stm32f10x_it.h）<br>②PendSV_Handler_NoSave不是函数，而是中间的一个标签，用于跳转<br>③每次运行PendSV_Handler，都会使pTCB_Cur指向pTCB_Rdy，所以调度中只需操作pTCB_Rdy<br>④SP_INIT是PSP指针初始化函数，用汇编写的，在其它地方被调用</p>
</blockquote>
<br>
<big>5、OS_Start与系统延时函数（阻塞，调度）</big>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void OS_Start(void)</span><br><span class="line">&#123;</span><br><span class="line">	PendSVPriority_Init();</span><br><span class="line">	SysTick_Init();</span><br><span class="line"></span><br><span class="line">	pTCB_Rdy = GetHighRdyTask();</span><br><span class="line">	pTCB_Rdy-&gt;state = eTask_Running;</span><br><span class="line">	SP_INIT();</span><br><span class="line">	SetPendSV();</span><br><span class="line">	<span class="keyword">while</span>(1);//等待调度</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//任务创建举例：</span><br><span class="line">create_new_task(Print_Task,<span class="string">"Print_Task"</span>,1,&amp;STK_PRINT_TASK[STK_SIZE-1],&amp;pT2);</span><br><span class="line">void Print_Task(void)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(1)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"print task\r\n"</span>);</span><br><span class="line">		OSDelayTicks(1000);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void OSDelayTicks(int ticks)</span><br><span class="line">&#123;</span><br><span class="line">	pTCB_Cur-&gt;state = eTask_Blocked;</span><br><span class="line">	pTCB_Cur-&gt;DlyTim = ticks-1;</span><br><span class="line">	OS_Schedule();</span><br><span class="line">	<span class="keyword">while</span>(pTCB_Cur-&gt;DlyTim != 0);//不能是<span class="keyword">while</span>(1)，否则下次任务解阻塞后，继续运行<span class="keyword">while</span>(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
<big>6、任务调度：SysTick_Handler函数</big>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void OS_Schedule(void)</span><br><span class="line">&#123;	</span><br><span class="line">	pTCB pT = GetHighRdyTask();</span><br><span class="line">	//检测是否需要任务切换，如果需要则挂起PendSV中断</span><br><span class="line">	<span class="keyword">if</span>(pT != pTCB_Cur)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(pTCB_Cur-&gt;state == eTask_Running)</span><br><span class="line">			pTCB_Cur-&gt;state = eTask_Ready;</span><br><span class="line">		</span><br><span class="line">		pTCB_Rdy = pT;</span><br><span class="line">		pTCB_Rdy-&gt;state = eTask_Running;</span><br><span class="line">	</span><br><span class="line">		SetPendSV();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void SysTick_Handler(void)</span><br><span class="line">&#123;	</span><br><span class="line">		int i = 0;	</span><br><span class="line">		os_cpu_interrupt_disable();</span><br><span class="line">		<span class="keyword">if</span>(GetTaskNum(eTask_Blocked) != 0)//延时任务列表中是否有阻塞任务</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(i = 0; i &lt; created_task_num; i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(TASK_LIST[i]-&gt;state == eTask_Blocked)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>(TASK_LIST[i]-&gt;DlyTim == 0)//延时时间到了，解除阻塞</span><br><span class="line">					&#123;</span><br><span class="line">						TASK_LIST[i]-&gt;state = eTask_Ready;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">						TASK_LIST[i]-&gt;DlyTim--;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(GetTaskNum(eTask_Ready) != 0)</span><br><span class="line">			OS_Schedule();</span><br><span class="line">		</span><br><span class="line">		os_cpu_interrupt_enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GitHub下载源码:<a href="https://github.com/cral-freedom/myRTOS" target="_blank" rel="noopener">https://github.com/cral-freedom/myRTOS</a></p>
<p>踩了不少坑，终于成功迈出了第一步：编写了一个具有多任务功能的RTOS；后续还有很多可以改动的地方（向FreeRTOS看齐）<br>基础的有：<br>    &emsp;如用双向链表（或其它数据结构）优化调度和管理，不阻塞调度的延时函数，阻塞调度的绝对延时函数，补充挂起和删除的操作。<br>更高级的：<br>    &emsp;内存管理、共享资源（消息队列、信号量、任务通知）的访问、中断管理，，，</p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2020-05-08T16:30:11.893Z" itemprop="dateUpdated">2020-05-09 00:30:11</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" target="_blank" rel="external">https://cral-freedom.github.io/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/</a>
        
    </div>
    <footer>
        <a href="https://cral-freedom.github.io/zhoujiabo.github.io">
            <img src="https://i.loli.net/2020/02/12/vtkHuf7DyOIhaST.jpg" alt="zhoujiabo">
            zhoujiabo
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/zhoujiabo.github.io/tags/PendSV/" rel="tag">PendSV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/zhoujiabo.github.io/tags/SysTick/" rel="tag">SysTick</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://cral-freedom.github.io/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/&title=《【编写RTOS】简单任务调度》 — Zhou's Blog&pic=https://i.loli.net/2020/02/12/vtkHuf7DyOIhaST.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://cral-freedom.github.io/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/&title=《【编写RTOS】简单任务调度》 — Zhou's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            
    <div id="comment"></div>



        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/zhoujiabo.github.io/2020/05/18/STM32CubeMX%E6%96%B0%E6%89%8B%E5%85%A5%E9%97%A8/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">STM32CubeMX新手入门</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E5%89%8D%E5%BA%8F/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">【编写RTOS】前序</h4>
      </a>
    </div>
  
</nav>


    
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/zhoujiabo.github.io/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/zhoujiabo.github.io/img/reward-wechat.jpg" data-alipay="/zhoujiabo.github.io/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://cral-freedom.github.io/zhoujiabo.github.io/" target="_blank">HOME</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                zhoujiabo &copy; 2020
            </span>
        		
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://cral-freedom.github.io/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/&title=《【编写RTOS】简单任务调度》 — Zhou's Blog&pic=https://i.loli.net/2020/02/12/vtkHuf7DyOIhaST.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://cral-freedom.github.io/zhoujiabo.github.io/2020/05/08/%E3%80%90%E7%BC%96%E5%86%99RTOS%E3%80%91%E7%AE%80%E5%8D%95%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/&title=《【编写RTOS】简单任务调度》 — Zhou's Blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAT4AAAE+CAAAAAAxUyPsAAAFPUlEQVR42u3aUW4bSRADUN3/0rsHCCSTrJF3gTx9GYk06nljwGxWv17x6583rz/f8+5T+dXaf3n3v5/v5d11Xt944cOHDx8+fMHNJMv9vOjkX/JV5TecPOzPjzm5X3z48OHDh+/Cl/yBb2/18+IuS88fTEKfRx98+PDhw4fv9/ly1qRKSFjzlTx7NXz48OHDh+//w5dv5vNNfv4Y2qiRjw3w4cOHDx++3+HbtuhtlbANBnKyFvEynMCHDx8+fPg2vnxo/ff8/JXzffjw4cOH76/n24JFu8nPg8j9CFqy2jyg/HB9fPjw4cOHb9JoIbbja3ntfolW+Uq2OgAfPnz48OF7ii+JEXlwuYeS9udt5JBfuRiT48OHDx8+fAFfu/lPYk2LmAO10WqrMyIBfPjw4cOH78CX/9m+Hztrl5vDJYVFe9zt7Tvx4cOHDx++mC8fMz91xC2pHrZRen6dS4lQzOrx4cOHDx++cnh8395vQ/F7uGkPrp3iET58+PDhwxfz5TFlq9236jzZ9o8j7fJA2w9RBh8+fPjw4Sv5ttF4W3NvQacNH5db3daDDx8+fPjwbXzJgrYafavj88Iip8wL/TrA4cOHDx8+fDHftqnOl57cwLghfyj05N/+w5QDHz58+PDhSxvvU5jIQ8NWQ1zG81thMZb1+PDhw4cPXzwmb29+W24+K7gEps/flUer6Jr48OHDhw/fxLdtpPOt9VPl+/ZI7oHsh7IeHz58+PDhK1PB5bhYvr1/6vqX4n57wD/86uDDhw8fPnwx370OyMfYeShJOF7x64shCR8+fPjw4Zv219sf8gt9Use3D+kyAs8Pt+HDhw8fPnwXvi0KPFXob1hPDdTbEFbPOvDhw4cPH76PfHnZ/WwsyMPNfQC/XeEtND58+PDhw1fy3bfibfho35OX+NvI/IGyHh8+fPjw4TuPyS9D7vag2KWyTyiT1Z5yHz58+PDhw1fuee91eQ73jWNn36gtHpgY4MOHDx8+fCXiVn/ni85DTB6tinN509ACHz58+PDhe4rvsm3eavpL3f8U0FaFRPUBPnz48OHDN43J25r7qdiRFBNtTd8O7/Hhw4cPH75v8F0CSn7z0ZGvaTP/jV18MYbHhw8fPnz4Sr48fCRxJL+xtspvs1h+xK09EIAPHz58+PBtfHmL0A7Rt/q7vdWW8mF0fPjw4cOH7/D3+tTrxzX3NibPa4g8Wm0PBh8+fPjw4bvwPVUHtCEmfyUr+fypNlQVn8KHDx8+fPiWXXxRDWzb/i2UtGP7fOVtRMOHDx8+fPi+wbdtrZPPtrfURop2uJ7XEEW1gQ8fPnz48AV890XndUD7PLci4DJgSI4I4MOHDx8+fBe+Nrhs8aUdaecV/OVA21Z/nCoDfPjw4cOHL77oJTTcx9jtlfPH3z6w+inhw4cPHz58ZRx5qj5oN+RJmb5duf0VeSD34cOHDx8+fB/L+m3znA+880jRlvttYbEFMnz48OHDh+/C126StxCzgW5Ve/5dybe//RQ+fPjw4cN35svL6/xrko16/ni24X0ewopghA8fPnz48C176lceGrYvbmnyqLE9nsvhgHYkjw8fPnz48P15j21YuR9Zy0v//DYuFUYeXPDhw4cPH76n+PKhdb4h39C3UqCNJo/t/fHhw4cPH75f4bsspT0uttHkx9rySIQPHz58+PD9V3zthj+//gaaB44EqPhFwYcPHz58+Ca+rQrPQ8NWxOeH1fIhQT4gj96DDx8+fPjwXXNIEW6eiiPtLeUhI394bSzDhw8fPnz4Sr5/AcNDr78eyQC/AAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/zhoujiabo.github.io/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/zhoujiabo.github.io/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/zhoujiabo.github.io/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/zhoujiabo.github.io/js/blog.js?v=1.4.4"></script>

<!-- third-party -->






<script type="text/javascript" src="/zhoujiabo.github.io/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/zhoujiabo.github.io/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
        <script type="text/javascript" src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript" src="/zhoujiabo.github.io/js/plugins/valine.js?v=1.4.4"></script>
    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>







    
</body>
</html>
